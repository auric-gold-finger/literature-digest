name: Post Release Notes to Slack

on:
  push:
    branches:
      - master
    paths:
      # Only trigger on code changes, not README or docs
      - '*.py'
      - 'utils/*.py'
      - 'sheet_import/*.csv'
      - 'requirements.txt'
      - '.github/workflows/*.yml'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  post-release-notes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to get diff
      
      - name: Get commit info
        id: commit
        run: |
          echo "message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%s" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%b" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT
          echo "date=$(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT
      
      - name: Get changed files
        id: changes
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD~1 HEAD | head -10 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Build the Slack message
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          COMMIT_BODY="${{ steps.commit.outputs.body }}"
          COMMIT_SHA="${{ steps.commit.outputs.sha }}"
          COMMIT_DATE="${{ steps.commit.outputs.date }}"
          CHANGED_FILES="${{ steps.changes.outputs.files }}"
          
          # Format changed files (replace newlines with commas)
          FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          
          # Build message text
          if [ -n "$COMMIT_BODY" ] && [ "$COMMIT_BODY" != " " ]; then
            BODY_TEXT="$COMMIT_BODY"
          else
            BODY_TEXT=""
          fi
          
          # Create simple JSON payload using jq for proper escaping
          jq -n \
            --arg title "üöÄ Literature Digest Updated" \
            --arg msg "$COMMIT_MSG" \
            --arg body "$BODY_TEXT" \
            --arg files "$FILES_LIST" \
            --arg sha "$COMMIT_SHA" \
            --arg date "$COMMIT_DATE" \
            '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": $title,
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ("*" + $msg + "*")
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": ("üìÅ " + $files)
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": ("üîó <https://github.com/auric-gold-finger/literature-digest/commit/" + $sha + "|" + $sha + "> ‚Ä¢ " + $date)
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ]
            }' > /tmp/slack_payload.json
          
          # Debug: show payload
          echo "Payload:"
          cat /tmp/slack_payload.json
          
          # Post to Slack
          RESPONSE=$(curl -s -X POST -H 'Content-type: application/json' \
            --data @/tmp/slack_payload.json \
            "$SLACK_WEBHOOK_URL")
          
          echo "Slack response: $RESPONSE"
          
          if [ "$RESPONSE" = "ok" ]; then
            echo "‚úÖ Release notes posted to Slack"
          else
            echo "‚ùå Failed to post: $RESPONSE"
            exit 1
          fi
